{"componentChunkName":"component---src-templates-blog-post-js","path":"/infra/continuous-deploy-using-github-actions-and-docker/","result":{"data":{"site":{"siteMetadata":{"title":"내가 재밌는 일을 하자 !"}},"markdownRemark":{"id":"e2925a14-19a7-5f30-8559-e0c46a966d9f","excerpt":"…","html":"<h2>들어가며</h2>\n<p>서비스를 지속적으로 발전하기 위해서는 많은 기능을 추가하거나 성능을 개선하는 등 많은 작업이 필연적으로 이뤄진다.<br>\n작업이 완료되면 이를 배포해야 하는데, 배포하는 과정이 귀찮고 길어지면 서비스를 지속적으로 발전하는 데 문제가 생긴다.</p>\n<p>따라서 <strong>배포를 자동화하는 작업은 서비스를 지속적으로 운영함에 있어 매우 중요한 작업</strong>이다.</p>\n<p>배포 자동화를 구축하는 방법과 툴은 여러 가지가 있지만, 이번 글에서는 Github Actions와 Docker를 이용해 구축하는 방법에 대해 작성해보겠다.</p>\n<h2>Architecture</h2>\n<p>배포 자동화가 수행되면 아래 그림과 같은 순서로 동작하게 될 것이다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7a9323470b8eddba193fffb97cbb0144/8affb/architecture.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.32911392405063%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB60lEQVR42oWS22rbQBCG/WZ9jl73qs/QFwh5gBC3l4XelJJelYLBGMfCTkkNgaS25aPkVJJ1sqzD6uj9u7NyFVpIO7Ca1emf+b/ZVpqm4JzjeDyKxQEc8WCW2HiV2HMEwQGr1Qqapsm8XC5lth0HFMpij/cjA2leiv8rtIqiQJZlSJIEURwLvQITG/h0D0x2HJ7nQt9uYRiGFN1sNtD1LZydBVXf4fWHCV6+u4OyDGSBFnXY7/fR7XZxfT2AZZnwDzHuLeDRLxDHEaqqkkUpQ/ZdX/dJgS93Fi66a9xqYS2Y5znCMITrulBVFbZtI88L+ZIwTKdTjMdjjEYjadX3fZimiYQxZCzG6qcN1WYCG2pBskzx+eoK52dn+HZzI+9/d6PpuliPwronuTmiMO0dsY8J0SlOemjRQOiD9uUlBoMB3rbbfwimLAKLvPoXngvEiXQxm80apuv1GmVZPlmmWCwWUBRFANdPJXldtUqQRz7Ui1eofnwFiwPkGUOaZrJDGiYtfvLcWCboxJFEh8Phkw0hyKI9vr95geL2Iz0QcEs8F40gZRKkAREfGkj9IgZPXUSOhvwgRp8F+Fc0lkmk0+k07BrMXNyHAkNiiKwBJftrDM90OJ/P0ev15LGoEXL8L8hFFEWSJWU6078AN/pApM71Z/IAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"전체 동작 흐름\"\n        title=\"\"\n        src=\"/static/7a9323470b8eddba193fffb97cbb0144/f058b/architecture.png\"\n        srcset=\"/static/7a9323470b8eddba193fffb97cbb0144/c26ae/architecture.png 158w,\n/static/7a9323470b8eddba193fffb97cbb0144/6bdcf/architecture.png 315w,\n/static/7a9323470b8eddba193fffb97cbb0144/f058b/architecture.png 630w,\n/static/7a9323470b8eddba193fffb97cbb0144/40601/architecture.png 945w,\n/static/7a9323470b8eddba193fffb97cbb0144/8affb/architecture.png 1254w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ol>\n<li>특정 브랜치에 Push or Merge가 발생하면 Github Actions를 통해 Deploy Workflow가 수행한다.</li>\n<li>Docker Hub에서 Image를 Pull하기 위해 Github Actions Host에서 EC2 인스턴스에 접속해야 한다.<br></li>\n</ol>\n<p>이를 위해 EC2 보안 그룹 인바운드 규칙에 현재 수행 중인 Github Actions Host의 IP를 추가해야 한다.\n3. Docker Image를 만들기 전, 프로젝트 설정 파일을 추가하고 프로젝트를 빌드한다.\n4. 프로젝트 빌드의 결과물을 Dockerfile을 이용해 Image로 만들고 Docker Hub에 Push 한다.\n5. EC2 인스턴스에 접속해 Docker Hub에 올려놓은 Image를 Pull 하고 실행시킨다.</p>\n<br>\n<p>이제 위 작업을 하나씩 수행해보자.</p>\n<h2>Docker Private Repository 만들기</h2>\n<p>우선 <a href=\"https://hub.docker.com/\">Docker Hub</a>에 접속 후 로그인하자.<br></p>\n<p>로그인 후 상단에 <code class=\"language-text\">Repository</code> 탭을 누르고 <code class=\"language-text\">Create Repository</code> 버튼을 누른다.</p>\n<p>그리고 <em>Repository Name</em>을 본인에 맞게 작성하자.<br>\n참고로 <code class=\"language-text\">account/repository name</code> 으로 생성된다.<br>\n작성했다면 아래 <code class=\"language-text\">Private</code>을 선택해 생성하자.</p>\n<p>생성하고 나면 아래 사진처럼 Private Repository가 존재할 것이다.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/902f132b288fbff163ccb384e19ad610/0d40b/private-repository.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.88607594936709%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA9UlEQVR42k2Nu0oDQRSG94VEVBAvTdDCoL6NL6CECCZEEAJW1lYi+ApCGrG3EBsL3Z0xu3Fns7Nz+xx3LTzwcX7O5f+T/o1kZypYv0zZmKTsXgmOriXbE8HWOGNtmLI6yFg5zehdCA7jvD8S7A0FvYHg4FxwPJbsn32wefJGkhaarDTkGmQVkMohvw2fi4Z0YSOGd6EQpeNLeYp4Uywhr2CuoGrg4ckwuq+5fWxItNYsqwprDD54nHNYa/Eu4l2LtYYQdxDoqushhFY/vxruZjWzl2hYR8N5XlAqhW6aiMFEw/D30PJP+4h1HhODjXXt/W8odIE/3mcd7w8IANYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"private repository\"\n        title=\"\"\n        src=\"/static/902f132b288fbff163ccb384e19ad610/f058b/private-repository.png\"\n        srcset=\"/static/902f132b288fbff163ccb384e19ad610/c26ae/private-repository.png 158w,\n/static/902f132b288fbff163ccb384e19ad610/6bdcf/private-repository.png 315w,\n/static/902f132b288fbff163ccb384e19ad610/f058b/private-repository.png 630w,\n/static/902f132b288fbff163ccb384e19ad610/40601/private-repository.png 945w,\n/static/902f132b288fbff163ccb384e19ad610/0d40b/private-repository.png 1175w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>Docker Access Token 발급받기</h2>\n<p>뒤에서 진행될 Docker Login과 GitHub Actions에서 Docker에 Login하기 위해 <em>Docker Access Token</em>이 필요하다.</p>\n<p>미리 발급을 받아놓자.</p>\n<p>우측 상단에 프로필 버튼을 눌러 <code class=\"language-text\">Account Settings</code> -> <code class=\"language-text\">Security</code>로 들어가면 <code class=\"language-text\">Access Tokens</code>가 있을 것이다.<br>\n<code class=\"language-text\">New Access Token</code> 버튼을 눌러 발급받자.<br>\n그리고 Token 값은 본인만 알고 있는 곳에 기록해놓으면 되겠다.</p>\n<h2>WAS에 접속해 Docker Login 해놓기</h2>\n<p>다음 단계로, WAS에 접속해 미리 Docker에 Login 해놓는 것이다.</p>\n<p>전체 동작 흐름을 보면 Actions Host에서 EC2 인스턴스에에 SSH로 접속 후, 미리 작성해놓은 스크립트를 수행한다.<br>\n이때, Docker Hub에서 Image를 Pull 받는 과정은 로그인이 된 상태에서 수행되어야 한다.<br></p>\n<p>WAS에 접속 후 <code class=\"language-text\">docker login --username ... --password ...</code> 명령어로 로그인을 해놓자.</p>\n<p>참고로 구글 계정으로 로그인을 했다면 password에 미리 발급받아놓은 <code class=\"language-text\">Docker Access Token</code> 값을 입력하면 된다.</p>\n<h2>Dockerfile</h2>\n<p>다음으로 <em>Dockerfile</em>을 작성해보겠다.<br>\nDockerfile은 우리가 만든 프로젝트를 이미지로 만들기 위해 필요한 스크립트 파일이다.<br></p>\n<p>작성한 Dockerfile은 다음과 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> arm64v8/amazoncorretto:17-alpine-jdk</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./build/libs/listywave.jar listywave.jar</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> TZ=Asia/Seoul</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENTRYPOINT</span> [<span class=\"token string\">\"java\"</span>, <span class=\"token string\">\"-jar\"</span>, <span class=\"token string\">\"listywave.jar\"</span>]</span></code></pre></div>\n<p>여기서 따로 수정이 필요할 수 있는 부분은 <code class=\"language-text\">FROM arm64v8/amazoncorretto:17-alpine-jdk</code> 이라고 생각한다.<br>\n필자의 EC2 인스턴스의 CPU 아키텍처가  <em>arm64v8</em> 라서 앞에 <code class=\"language-text\">arm64v8</code>을 추가해주었다.<br>\n본인 환경에 맞게 수정해주면 되겠다.</p>\n<p>Dockerfile은 프로젝트 경로 최상단에 위치시키면 된다.</p>\n<h2>CD Workflow</h2>\n<p>이제 셋팅은 모두 끝났다. 배포 자동화의 전체 동작을 기술한 Workflow를 작성해보자.<br>\n<code class=\"language-text\">/프로젝트 최상단/.github/workflows/</code> 경로에 아래 yml 파일을 작성하자.</p>\n<p>각 step 별로 name을 한글로 적었으니, 각각 어떤 작업을 수행하는지 파악할 수 있을 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># prod-cd.yml</span>\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy to PROD\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">workflow_dispatch</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"prod\"</span> <span class=\"token punctuation\">]</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Github Actions 호스트 IP 가져오기\n        <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> ip\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> haythem/public<span class=\"token punctuation\">-</span>ip@bdddd92c198b0955f0b494a8ebeac529754262ff\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> AWS 로그인\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> aws<span class=\"token punctuation\">-</span>actions/configure<span class=\"token punctuation\">-</span>aws<span class=\"token punctuation\">-</span>credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">aws-access-key-id</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.AWS_ACCESS_KEY_ID <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">aws-secret-access-key</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.AWS_SECRET_ACCESS_KEY <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">aws-region</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.AWS_DEFAULT_REGION <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> IP 허용\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          aws ec2 authorize-security-group-ingress --group-id ${{ secrets.AWS_SECURITY_GROUP_ID }} --protocol \"tcp\" --port \"${{ secrets.EC2_PORT }}\" --cidr \"${{ steps.ip.outputs.ipv4 }}/32\"</span>\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">AWS_ACCESS_KEY_ID</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.AWS_ACCESS_KEY_ID <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">AWS_SECRET_ACCESS_KEY</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.AWS_SECRET_ACCESS_KEY <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">AWS_DEFAULT_REGION</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.AWS_DEFAULT_REGION <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 저장소 Checkout\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v4\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 설정 파일 추가\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          cd ./src/main/resources/</span>\n\n          cat &lt;&lt;EOF <span class=\"token punctuation\">></span> application<span class=\"token punctuation\">-</span>prod.yml\n          $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.APPLICATION_PROD_YML <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          EOF\n\n          cat &lt;&lt;EOF <span class=\"token punctuation\">></span> application<span class=\"token punctuation\">-</span>oauth.yml\n          $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.APPLICATION_OAUTH_YML <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          EOF\n\n          cat &lt;&lt;EOF <span class=\"token punctuation\">></span> application<span class=\"token punctuation\">-</span>storage.yml\n          $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.APPLICATION_STORAGE_YML <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          EOF\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 디렉터리 이동\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> cd /home/runner/work/ListyWave<span class=\"token punctuation\">-</span>back/ListyWave<span class=\"token punctuation\">-</span>back/\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Gradle 셋업<span class=\"token punctuation\">,</span> 빌드<span class=\"token punctuation\">,</span> 캐싱\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> burrunan/gradle<span class=\"token punctuation\">-</span>cache<span class=\"token punctuation\">-</span>action@3bf23b8dd95e7d2bacf2470132454fe893a178a1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">arguments</span><span class=\"token punctuation\">:</span> bootJar\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 도커 이미지 빌드\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> docker build <span class=\"token punctuation\">-</span>t $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DOCKER_HUB_USERNAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>/$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.IMAGE_NAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span>$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.PROD_TAG <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> ./\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 도커 허브에 로그인\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> docker/login<span class=\"token punctuation\">-</span>action@0d4c9c5ea7693da7b068278f7b52bda2a190a446\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DOCKER_HUB_USERNAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DOCKER_HUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 도커 허브에 Push\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> docker push $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DOCKER_HUB_USERNAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>/$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.IMAGE_NAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span>$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.PROD_TAG <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 인스턴스 접속 및 배포 스크립트 실행\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> appleboy/ssh<span class=\"token punctuation\">-</span>action@029f5b4aeeeb58fdfe1410a5d17f967dacf36262\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.PROD_EC2_HOST <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.EC2_USERNAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.PROD_EC2_PRIVATE_KEY <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n            docker stop \"${{ secrets.CONTAINER_NAME }}\"\n            docker rm -f \"${{ secrets.CONTAINER_NAME }}\"\n            docker rmi \"${{ secrets.DOCKER_HUB_USERNAME }}/${{ secrets.IMAGE_NAME }}:${{ secrets.PROD_TAG }}\"\n            docker pull \"${{ secrets.DOCKER_HUB_USERNAME }}/${{ secrets.IMAGE_NAME }}:${{ secrets.PROD_TAG }}\"\n            docker run -d -p 8080:8080 --name \"${{ secrets.PROD_CONTAINER_NAME }}\" \"${{ secrets.DOCKER_HUB_USERNAME }}/${{ secrets.IMAGE_NAME }}:${{ secrets.PROD_TAG }}\"</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> IP 제거\n        <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> always() <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> <span class=\"token comment\"># 반드시 추가해야 한다. 추가하지 않으면 보안 그룹에 추가한 IP가 삭제되지 않는다!!</span>\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          aws ec2 revoke-security-group-ingress --group-id \"${{ secrets.AWS_SECURITY_GROUP_ID }}\" --protocol \"tcp\" --port \"${{ secrets.EC2_PORT }}\" --cidr \"${{ steps.ip.outputs.ipv4 }}/32\"</span>\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">AWS_ACCESS_KEY_ID</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.AWS_ACCESS_KEY_ID <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">AWS_SECRET_ACCESS_KEY</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.AWS_SECRET_ACCESS_KEY <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">AWS_DEFAULT_REGION</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.AWS_DEFAULT_REGION <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Github Repository에 Secret 값 넣어주기</h2>\n<p>이제 위 workflow가 정상적으로 수행할 수 있도록 <em>Secrets</em> 값들을 넣어주자.</p>\n<p>프로젝트의 GitHub Repository에서 <code class=\"language-text\">Settings</code> - <code class=\"language-text\">Secrets and variables</code> - <code class=\"language-text\">Actions</code>로 들어가자.</p>\n<p>그리고 <code class=\"language-text\">New Repository secret</code> 버튼을 눌러 Secrets 값들을 저장해주면 된다.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ed5450b26d4595e89a8b59d2a6d69b8a/0d6fe/actions-secrets.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.0253164556962%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB3UlEQVR42m1Ty5KbQAzkS1IxmPcMM8MbDPYudrmczTX3VOX//6EjCROTZA9dzAghdbeEF6QWUV4hUhXCrESYl4h1jSAxOGZOwDnH1MGnmB8XdLZ0LhCmBoOyaHKKBym+HHN4mengugtiVSPVDdKilQa2mVAPb4QLym5GO11RVKMUDBIrDTdwo4Ab0jsvpo9NPUG5AZlp4UeFJDWnK+r5G4rxA3p4QLU36O6GalhQj+/0fJecdrrRfZFz7np4zMa1Z5hmFtmHSJMkg5I+rKYHqvN3en7A9Qts9wZLubadocoBuhyFSG57ARPxYsXyziSzlGJMm5HZDrlpkBW1ICf22RNJ0axSn7l7SEH++Guo/nrBDBQxYBl8P4RaGm74rJgw5G4Vme/vOrLpPJzV106mug7Arufn/ZX/gscShstdZPzb+UCs9zE2vz/f0c13mv7yKvqctC8e0s6xyZup0pGLbdJ2BdkeXi8GD/MPw1gRNGKCx5NNSRYXloWOrXTitWBGWnbP7GTv9o/iuizx+Lng8euK248TSaYiA+2SrU5QJD+ixIQ6OZo8L7ymOLNnT/+DXn124wWqHpG5Dp5RJfp2QkMBo4ktFVNkriJPuZihP+Yzfzcwcy4e0p9yTCx+AyB9cWKXKAB2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Actions Secrets\"\n        title=\"\"\n        src=\"/static/ed5450b26d4595e89a8b59d2a6d69b8a/f058b/actions-secrets.png\"\n        srcset=\"/static/ed5450b26d4595e89a8b59d2a6d69b8a/c26ae/actions-secrets.png 158w,\n/static/ed5450b26d4595e89a8b59d2a6d69b8a/6bdcf/actions-secrets.png 315w,\n/static/ed5450b26d4595e89a8b59d2a6d69b8a/f058b/actions-secrets.png 630w,\n/static/ed5450b26d4595e89a8b59d2a6d69b8a/40601/actions-secrets.png 945w,\n/static/ed5450b26d4595e89a8b59d2a6d69b8a/0d6fe/actions-secrets.png 1115w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>위 Workflow를 위에서부터 하나씩 <strong>천천히!</strong> <strong>차근차근!</strong> 보면서 저장해주자.<br>\n필자는 단 하나를 빠트려 2시간을 날렸다.. 😭😭</p>\n<h2>동작 확인하기</h2>\n<p>이제 설정한 브랜치에 코드를 push해서 제대로 동작하는지 확인하면 모든 작업은 끝이 난다.</p>\n<p>만약 작업이 실패한다면, <code class=\"language-text\">Actions</code> 탭에서 해당 workflow의 로그를 살펴보며 어디서 실패했는지 확인하면 된다.<br>\n대부분 설정 하나를 빠트렸다거나, 값을 잘못 작성했다거나 하는 문제일 가능성이 크기 때문에<br>\n로그를 읽고 하나씩 해결하면 모두 올바르게 동작할 것이다.</p>\n<h2>마무리</h2>\n<p>인프라 작업은 다양한 곳에서 설정해줘야 하기에 세심함이 필요하다.<br>\n급하게 하기보단 하나씩 작업을 수행하고 확인하는 식으로 진행하는 것을 추천한다.</p>\n<p>혹여나 설명이 빠졌거나 부족한 부분이 있다면 언제든지 댓글로 알려주세요.<br>\n감사합니다.</p>","frontmatter":{"title":"[Infra] Github Actions와 Docker를 이용해 배포 자동화 구축하기","date":"May 29, 2024","description":"Github Actions와 Docker를 이용해 배포 자동화 구축하기"}},"previous":{"fields":{"slug":"/infra/enhance-speed-ci-workflow/"},"frontmatter":{"title":"[Infra] Github Actions를 이용한 CI 작업 속도를 캐싱으로 개선하기"}},"next":{"fields":{"slug":"/infra/build-monitoring-system/"},"frontmatter":{"title":"[Infra] Prometheus와 Grafana, 그리고 Docker를 이용해 모니터링 대시보드 구축하기"}}},"pageContext":{"id":"e2925a14-19a7-5f30-8559-e0c46a966d9f","previousPostId":"eb96b910-f530-5aea-8c57-b0a27eac34c3","nextPostId":"80ca67ec-36c4-59bb-ada7-a3668cf0a503"}},"staticQueryHashes":["2841359383"],"slicesMap":{}}