{"componentChunkName":"component---src-templates-blog-post-js","path":"/셀럽잇 프로젝트/zero-downtime-deployment-of-celuveat/","result":{"data":{"site":{"siteMetadata":{"title":"김동호 블로그"}},"markdownRemark":{"id":"fb649a13-ad43-5201-8788-27364a0951cc","excerpt":"이번 글에선 셀럽잇이 왜? 그리고 어떻게? 무중단 배포를 적용했는 지에 대해 작성하고자 합니다. 무중단 배포를 왜 하는가? 서버가 1개인 상황에서 새로 배포를 하게 되면, 배포가 완료되는 시간동안 사용자들은 서비스를 이용하지 못합니다. 배포 시간이 3초만 되어도 사용자는…","html":"<p>이번 글에선 셀럽잇이 왜? 그리고 어떻게? 무중단 배포를 적용했는 지에 대해 작성하고자 합니다.</p>\n<h2 id=\"무중단-배포를-왜-하는가\" style=\"position:relative;\"><a href=\"#%EB%AC%B4%EC%A4%91%EB%8B%A8-%EB%B0%B0%ED%8F%AC%EB%A5%BC-%EC%99%9C-%ED%95%98%EB%8A%94%EA%B0%80\" aria-label=\"무중단 배포를 왜 하는가 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.65 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>무중단 배포를 왜 하는가?</h2>\n<p>서버가 1개인 상황에서 새로 배포를 하게 되면, 배포가 완료되는 시간동안 사용자들은 서비스를 이용하지 못합니다.</p>\n<p>배포 시간이 3초만 되어도 사용자는 3초 동안 에러 페이지만 보게 될 것입니다.</p>\n<p>아래 사진은 구글이 제공하는 데이터입니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/87b7ec682cc359165838f00f42318a60/00d43/user-bounce-rate-due-to-page-load-time.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.62025316455697%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACTUlEQVR42o1TbW/TMBjk//8EvoEE26rBF4SAjbZjMDGE2Fg37T1N1rVLllcnjh0njns8cbdKlSa0RJdzbOty9zzOC91ojI5HmMU+nLEDpRS01miaBnVdr/DjuEPbtnjqeiGFxEavh9HkDMPdHWRZhjzPEUURkiRBmqYWjDGEYWiZ0Z6qqp4W7B7GGBhtFtwuuHPwCPtOmHfrc4PaUIIHSEOOTbMq+Cs7w3v/Oz7e7yPMYiRxjDAK4fs+giCwrq1jmg9YhJN8jIPsAkf5FU4LFzcyWBU8LTwMo0PsJcfgWtoF8mNvM1/wcy8r2FlXZLtjXWu0BK2oAUKhlgqK6iWEgJQSXAkEKoVfxZbviOOarQruxkd4c7uN3myIwfQ3ttx9fHF/4pOzR/iBSToDzwtqBkNaMozFHS75BFflrR37KlkVnFYhTrmHc9o04mMcly7Bw4n0MCrHYLq0m58T3QqmTYGgSmwEJSrUnGIWEiLjEIzAS3tUcjoyMU/J2RTnxQ0uyIBLDk9yBy11fynYD//gpfcBryaf0bsZYN3ZxpqzhbfXW1i73sa6+xXf7g4gqY68KunDCaWKMKP65eQ+Upk9TkvBqq1R6soibwUYoTA0NtIiMyWEUc/v8j1FnckInvSRCIaqEChZgTzOkIYxKk7dzQoUKTWFojt8Zs/fIbuEJ3yK7CIkl0vBnegvXlPc9WkfG7cDvJsMseH10fMGhD42qQybD3NTfk+JFDKqe9LkEG1l8fi3WMEuatpw2sQtJ7pAqvkS3XvSLOaauf5v5H9iPChDP/AiLQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"페이지 로딩 시간에 따른 사용자 이탈률\"\n        title=\"\"\n        src=\"/static/87b7ec682cc359165838f00f42318a60/f058b/user-bounce-rate-due-to-page-load-time.png\"\n        srcset=\"/static/87b7ec682cc359165838f00f42318a60/c26ae/user-bounce-rate-due-to-page-load-time.png 158w,\n/static/87b7ec682cc359165838f00f42318a60/6bdcf/user-bounce-rate-due-to-page-load-time.png 315w,\n/static/87b7ec682cc359165838f00f42318a60/f058b/user-bounce-rate-due-to-page-load-time.png 630w,\n/static/87b7ec682cc359165838f00f42318a60/40601/user-bounce-rate-due-to-page-load-time.png 945w,\n/static/87b7ec682cc359165838f00f42318a60/00d43/user-bounce-rate-due-to-page-load-time.png 1000w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>무려 3초만 서비스를 이용하지 못하더라도 약 1/3 의 사용자가 이탈합니다.</p>\n<p><strong>따라서 실사용자가 있는 상황에서 배포에 따른 Down-Time을 제거하기 위해 무중단 배포를 적용해야 합니다.</strong></p>\n<h2 id=\"무중단-배포-방식-결정하기\" style=\"position:relative;\"><a href=\"#%EB%AC%B4%EC%A4%91%EB%8B%A8-%EB%B0%B0%ED%8F%AC-%EB%B0%A9%EC%8B%9D-%EA%B2%B0%EC%A0%95%ED%95%98%EA%B8%B0\" aria-label=\"무중단 배포 방식 결정하기 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.65 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>무중단 배포 방식 결정하기</h2>\n<p>무중단 배포에는 <em>롤링 방식</em>, <em>블루/그린 방식</em>, <em>카나리 방식</em>이 있습니다.</p>\n<blockquote>\n<p>(<a href=\"https://kdkdhoho.github.io/zero-downtime-deployment\">무중단 배포 방식에 대해 정리한 글</a>)</p>\n</blockquote>\n<p>이 중, 현재 주어진 리소스를 고려하여 최적의 방식을 선택하려고 합니다.</p>\n<p>현재 리소스 상황으로는, 배포 서버로 EC2 인스턴스 1대를 사용중입니다.<br>\n해당 인스턴스에서 리버스 프록시 역할의 Nginx와 스프링 애플리케이션이 존재합니다.<br>\n이러한 상황에서 무중단 배포를 위한 인스턴스를 추가로 사용하기 위해선 기술 검토 요청을 보내야 하며 그 동안의 대기 시간이 필요합니다.<br>\n또한, 추가 사용이 가능한지도 미지수인 상황이었습니다.</p>\n<p>따라서 한 대의 서버에서 무중단 배포를 적용하기엔 <strong>블루/그린 방식</strong>이 최적의 방식이라고 판단했습니다.</p>\n<blockquote>\n<p>더불에 블루/그린 방식의 문제점을 생각해봤을 때, 배포 서버의 자원을 2배로 사용한다는 점은 서비스를 운영함에 있어 문제되지 않았습니다.</p>\n</blockquote>\n<h2 id=\"배포-전략\" style=\"position:relative;\"><a href=\"#%EB%B0%B0%ED%8F%AC-%EC%A0%84%EB%9E%B5\" aria-label=\"배포 전략 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.65 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>배포 전략</h2>\n<p>기본적으로 2개의 포트를 사용합니다.<br>\n저희 팀은 8080, 그리고 8081 포트를 사용하기로 했습니다.</p>\n<p>배포 과정의 전체적인 Flow는 다음과 같습니다.</p>\n<ol>\n<li>비어있는 포트(Idle Port)를 찾는다.</li>\n<li>해당 포트에 새로운 버전(그린)을 배포한다.</li>\n<li>그린이 이상없이 동작하는지 확인하기 위해 헬스 체크를 진행한다.</li>\n<li>문제가 없다면, Nginx의 포트 포워딩 설정을 그린으로 변경하고 기존 버전(블루)을 종료한다.<br>\n문제가 있다면, 그린을 종료한다.</li>\n</ol>\n<hr>\n<p>위 시나리오의 과정에 대해 더 자세히 말씀드리겠습니다.</p>\n<p>1)<br>\nIdle Port를 찾는 방법은, 8080 포트에 API 요청을 보내고 그에 따른 응답의 결과로 찾습니다.<br>\n만약 응답 코드가 200이면 현재 8080 포트에서 블루가 동작중인 셈이니 8081포트가 Idle Port가 됩니다.</p>\n<p>21)<br>\n이런 식으로 찾은 Idle Port에 그린을 배포합니다.</p>\n<p>3)<br>\n이후, 그린의 헬스 체크를 진행하기 위해 30초의 대기 시간을 가집니다.<br>\n대기 시간을 가지는 이유는 그린이 띄어진 직후에 실행한 헬스 체크는 정상으로 확인되었지만, 이후에 혹여나 예상치 못한 문제로 그린이 Down 될 가능성을 염두했기 때문입니다.<br>\n또한 당시 스프링 애플리케이션이 서버에 완전히 띄어지기까지 약 20초의 시간이 소요되는 점을 고려했기 때문입니다.</p>\n<p>4)<br>\n이후 헬스 체크를 진행합니다.<br>\n체크 결과, 그린 서버가 정상적으로 배포가 됐다면 Nginx의 포트 포워딩 설정을 변경합니다. 그리고 5초의 여유를 가지고 블루 서버를 종료합니다.\n그린 서버에 문제가 생겨 정상적으로 실행되지 않았다면 종료합니다.</p>\n<h2 id=\"배포-스크립트\" style=\"position:relative;\"><a href=\"#%EB%B0%B0%ED%8F%AC-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8\" aria-label=\"배포 스크립트 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.65 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>배포 스크립트</h2>\n<p>위 시나리오대로 작성한 배포 스크립트는 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">RESPONSE_CODE</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-o</span> /dev/null <span class=\"token parameter variable\">-w</span> <span class=\"token string\">\"%{http_code}\"</span> http://localhost:8080/celebs<span class=\"token variable\">)</span></span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">${RESPONSE_CODE}</span> <span class=\"token operator\">=</span> <span class=\"token number\">200</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">then</span>\n        <span class=\"token assign-left variable\">IDLE_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">8081</span>\n        <span class=\"token assign-left variable\">IDLE_MONITORING_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">18082</span>\n        <span class=\"token assign-left variable\">USED_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">8080</span>\n    <span class=\"token keyword\">else</span>\n        <span class=\"token assign-left variable\">IDLE_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">8080</span>\n        <span class=\"token assign-left variable\">IDLE_MONITORING_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">18081</span>\n        <span class=\"token assign-left variable\">USED_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">8081</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"IDLE_PORT=<span class=\"token variable\">${IDLE_PORT}</span>\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"IDLE_MONITORING_PORT=<span class=\"token variable\">${IDLE_MONITORING_PORT}</span>\"</span>\n\n<span class=\"token assign-left variable\">IMAGE_TAG</span><span class=\"token operator\">=</span>back-prod-<span class=\"token variable\">${APP_VERSION_TAG}</span>\n<span class=\"token assign-left variable\">DOCKER_CONTAINER_NAME</span><span class=\"token operator\">=</span>backend-<span class=\"token variable\">${IDLE_PORT}</span>\n<span class=\"token assign-left variable\">DOCKER_HUB_REPOSITORY</span><span class=\"token operator\">=</span>celuveat/celuveat\n<span class=\"token assign-left variable\">SERVER_LOG_DIR_PATH</span><span class=\"token operator\">=~</span>/log\n<span class=\"token assign-left variable\">DOCKER_LOG_DIR_PATH</span><span class=\"token operator\">=</span>/app/logs\n\n<span class=\"token function\">docker</span> pull <span class=\"token variable\">${DOCKER_HUB_REPOSITORY}</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">${IMAGE_TAG}</span>\n<span class=\"token function\">docker</span> run <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">-d</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--name</span> <span class=\"token variable\">${DOCKER_CONTAINER_NAME}</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">-p</span> <span class=\"token variable\">$IDLE_PORT</span>:8080 <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">-p</span> <span class=\"token variable\">$IDLE_MONITORING_PORT</span>:18080 <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"SPRING_PROFILES_ACTIVE=prod\"</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">-v</span> <span class=\"token variable\">${SERVER_LOG_DIR_PATH}</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">${DOCKER_LOG_DIR_PATH}</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token variable\">${DOCKER_HUB_REPOSITORY}</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">${IMAGE_TAG}</span>\n\n<span class=\"token comment\"># 새로 뜬 컨테이너 확인</span>\n<span class=\"token function\">sleep</span> <span class=\"token number\">30</span>\n<span class=\"token assign-left variable\">HEALTHY_CODE</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-o</span> /dev/null <span class=\"token parameter variable\">-w</span> <span class=\"token string\">\"%{http_code}\"</span> http://localhost:$<span class=\"token punctuation\">{</span>IDLE_PORT<span class=\"token punctuation\">}</span>/celebs<span class=\"token variable\">)</span></span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">${HEALTHY_CODE}</span> <span class=\"token operator\">!=</span> <span class=\"token number\">200</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">then</span>\n            <span class=\"token assign-left variable\">IDLE_CONTAINER_ID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">docker</span> <span class=\"token function\">ps</span> <span class=\"token parameter variable\">-q</span> <span class=\"token parameter variable\">--filter</span> <span class=\"token string\">\"publish=<span class=\"token variable\">${IDLE_PORT}</span>\"</span><span class=\"token variable\">)</span></span>\n            <span class=\"token function\">docker</span> stop <span class=\"token variable\">${IDLE_CONTAINER_ID}</span>\n            <span class=\"token function\">docker</span> <span class=\"token function\">rm</span> <span class=\"token variable\">${IDLE_CONTAINER_ID}</span>\n            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"TERMINATED\"</span>\n            <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"set \\<span class=\"token variable\">$service_url</span> http://127.0.0.1:<span class=\"token variable\">${IDLE_PORT}</span>;set \\<span class=\"token variable\">$service_monitoring_url</span> http://127.0.0.1:<span class=\"token variable\">${IDLE_MONITORING_PORT}</span>;\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /etc/nginx/conf.d/service-url.inc\n<span class=\"token function\">sudo</span> <span class=\"token function\">service</span> nginx reload\n\n<span class=\"token function\">sleep</span> <span class=\"token number\">5</span>\n<span class=\"token assign-left variable\">USED_CONTAINER_ID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">docker</span> <span class=\"token function\">ps</span> <span class=\"token parameter variable\">-q</span> <span class=\"token parameter variable\">--filter</span> <span class=\"token string\">\"publish=<span class=\"token variable\">${USED_PORT}</span>\"</span><span class=\"token variable\">)</span></span>\n<span class=\"token function\">docker</span> stop <span class=\"token variable\">${USED_CONTAINER_ID}</span>\n<span class=\"token function\">docker</span> <span class=\"token function\">rm</span> <span class=\"token variable\">${USED_CONTAINER_ID}</span>\n<span class=\"token function\">docker</span> image prune <span class=\"token parameter variable\">-f</span></code></pre></div>\n<h2 id=\"추가로-신경써야-할-점\" style=\"position:relative;\"><a href=\"#%EC%B6%94%EA%B0%80%EB%A1%9C-%EC%8B%A0%EA%B2%BD%EC%8D%A8%EC%95%BC-%ED%95%A0-%EC%A0%90\" aria-label=\"추가로 신경써야 할 점 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.65 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>추가로 신경써야 할 점</h2>\n<p>기존에 애플리케이션 모니터링을 위해 Spring Actuator에 포트를 할당해 사용하고 있었습니다.<br>\n따라서 모니터링을 위한 포트도 함께 변경해줘야 합니다.</p>\n<p>저희 팀은 <code class=\"language-text\">8080, 18080</code> / <code class=\"language-text\">8081, 18081</code> 으로 묶어 관리하기로 결정했습니다.</p>\n<p>모니터링을 위한 포트도 마찬가지로 Nginx에서 포트 포워딩을 통해 처리해줍니다.</p>\n<p><strong>그런데 여기서 중요한 점이 있습니다!!</strong><br>\nNginx에서 Actuator로 향하는 포트를 listen하기 위해 18080 포트를 사용하고 있었습니다.<br>\n즉, Actuator의 포트로 18080 포트를 사용하지 못하게 됩니다.</p>\n<p>결과적으로 모니터링을 위한 포트는 <code class=\"language-text\">18081</code> 과 <code class=\"language-text\">18082</code> 를 사용하게 되었습니다.</p>\n<h2 id=\"nginx-설정\" style=\"position:relative;\"><a href=\"#nginx-%EC%84%A4%EC%A0%95\" aria-label=\"nginx 설정 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.65 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Nginx 설정</h2>\n<p>아래는 Nginx 포트 포워딩 설정 스크립트입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">server <span class=\"token punctuation\">{</span>\n  listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span>\n  server_name api.celuveat.com<span class=\"token punctuation\">;</span>\n\n  ssl_certificate /etc/letsencrypt/live/api.celuveat.com/fullchain.pem<span class=\"token punctuation\">;</span>\n  ssl_certificate_key /etc/letsencrypt/live/api.celuveat.com/privkey.pem<span class=\"token punctuation\">;</span>\n\n  include /etc/nginx/conf.d/service-url.inc<span class=\"token punctuation\">;</span>\n  location / <span class=\"token punctuation\">{</span>\n    proxy_pass <span class=\"token variable\">$service_url</span><span class=\"token punctuation\">;</span>\n    proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span>\n    proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span>\n    proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span>\n    proxy_set_header X-Forwarded-Proto <span class=\"token variable\">$scheme</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\nserver <span class=\"token punctuation\">{</span>\n  listen <span class=\"token number\">18080</span><span class=\"token punctuation\">;</span>\n  include /etc/nginx/conf.d/service-url.inc<span class=\"token punctuation\">;</span>\n  location / <span class=\"token punctuation\">{</span>\n    proxy_pass <span class=\"token variable\">$service_monitoring_url</span><span class=\"token punctuation\">;</span>\n    proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span>\n    proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span>\n    proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span>\n    proxy_set_header X-Forwarded-Proto <span class=\"token variable\">$scheme</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"기타-설정-참고용\" style=\"position:relative;\"><a href=\"#%EA%B8%B0%ED%83%80-%EC%84%A4%EC%A0%95-%EC%B0%B8%EA%B3%A0%EC%9A%A9\" aria-label=\"기타 설정 참고용 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.65 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>기타 설정 (참고용)</h2>\n<p>Github Actions Workflow는 아래와 같이 수정되었습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">name: ✨ Celuveat backend PROD CD ✨\n\nenv:\n  PROFILE: prod\n  IMAGE_TAG: back-prod-<span class=\"token variable\">${{ secrets.APP_VERSION_TAG }</span><span class=\"token punctuation\">}</span>\n  DOCKER_CONTAINER_NAME: backend\n  DOCKER_HUB_REPOSITORY: celuveat/celuveat\n  SERVER_LOG_DIR_PATH: ~/log\n  DOCKER_LOG_DIR_PATH: /app/logs\n\non:\n  workflow_dispatch:\n  push:\n    branches:\n      - main\n    paths:\n      - <span class=\"token string\">\"backend/**\"</span>\n\njobs:\n  backend-docker-build-and-push:\n    runs-on: ubuntu-latest\n    defaults:\n      run:\n        working-directory: ./backend\n\n    steps:\n      - name: ✨ Checkout repository\n        uses: actions/checkout@v3\n        with:\n          submodules: <span class=\"token boolean\">true</span>\n          token: <span class=\"token variable\">${{ secrets.ACTION_TOKEN }</span><span class=\"token punctuation\">}</span>\n\n      - name: ✨ JDK <span class=\"token number\">17</span> 설정\n        uses: actions/setup-java@v3\n        with:\n          java-version: <span class=\"token string\">'17'</span>\n          distribution: <span class=\"token string\">'temurin'</span>\n\n      - name: ✨ Gradle Caching\n        uses: actions/cache@v3\n        with:\n          path: <span class=\"token operator\">|</span>\n            ~/.gradle/caches\n            ~/.gradle/wrapper\n          key: <span class=\"token variable\">${{ runner.os }</span><span class=\"token punctuation\">}</span>-gradle-<span class=\"token variable\">${{ hashFiles('**<span class=\"token operator\">/</span>*.gradle*'<span class=\"token operator\">,</span> '**<span class=\"token operator\">/</span>gradle-wrapper.properties') }</span><span class=\"token punctuation\">}</span>\n          restore-keys: <span class=\"token operator\">|</span>\n            <span class=\"token variable\">${{ runner.os }</span><span class=\"token punctuation\">}</span>-gradle-\n\n      - name: ✨ Gradlew 권한 설정\n        run: <span class=\"token function\">chmod</span> +x ./gradlew\n\n      - name: ✨ Jar 파일 빌드\n        run: ./gradlew bootJar\n\n      - name: ✨ DockerHub에 로그인\n        uses: docker/login-action@v2\n        with:\n          username: <span class=\"token variable\">${{ secrets.DOCKER_HUB_USERNAME }</span><span class=\"token punctuation\">}</span>\n          password: <span class=\"token variable\">${{ secrets.DOCKER_HUB_PASSWORD }</span><span class=\"token punctuation\">}</span>\n\n      - name: ✨ Docker Image 빌드 후 DockerHub에 Push\n        uses: docker/build-push-action@v4\n        with:\n          context: ./backend\n          file: ./backend/Dockerfile\n          push: <span class=\"token boolean\">true</span>\n          platforms: linux/arm64\n          tags: <span class=\"token variable\">${{ env.DOCKER_HUB_REPOSITORY }</span><span class=\"token punctuation\">}</span>:<span class=\"token variable\">${{ env.IMAGE_TAG }</span><span class=\"token punctuation\">}</span>\n\n  backend-docker-pull-and-run:\n    runs-on: <span class=\"token punctuation\">[</span>self-hosted, prod<span class=\"token punctuation\">]</span>\n    if: <span class=\"token variable\">${{ needs.backend-docker-build-and-push.result == 'success' }</span><span class=\"token punctuation\">}</span>\n    needs: <span class=\"token punctuation\">[</span> backend-docker-build-and-push <span class=\"token punctuation\">]</span>\n    steps:\n      - name: ✨ 배포 스크립트 실행\n        run: <span class=\"token operator\">|</span>\n          <span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">APP_VERSION_TAG</span><span class=\"token operator\">=</span><span class=\"token variable\">${{ secrets.APP_VERSION_TAG }</span><span class=\"token punctuation\">}</span>\n          <span class=\"token function\">sh</span> /home/ubuntu/deploy.sh</code></pre></div>","tableOfContents":"<ul>\n<li><a href=\"#%EB%AC%B4%EC%A4%91%EB%8B%A8-%EB%B0%B0%ED%8F%AC%EB%A5%BC-%EC%99%9C-%ED%95%98%EB%8A%94%EA%B0%80\">무중단 배포를 왜 하는가?</a></li>\n<li><a href=\"#%EB%AC%B4%EC%A4%91%EB%8B%A8-%EB%B0%B0%ED%8F%AC-%EB%B0%A9%EC%8B%9D-%EA%B2%B0%EC%A0%95%ED%95%98%EA%B8%B0\">무중단 배포 방식 결정하기</a></li>\n<li><a href=\"#%EB%B0%B0%ED%8F%AC-%EC%A0%84%EB%9E%B5\">배포 전략</a></li>\n<li><a href=\"#%EB%B0%B0%ED%8F%AC-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8\">배포 스크립트</a></li>\n<li><a href=\"#%EC%B6%94%EA%B0%80%EB%A1%9C-%EC%8B%A0%EA%B2%BD%EC%8D%A8%EC%95%BC-%ED%95%A0-%EC%A0%90\">추가로 신경써야 할 점</a></li>\n<li><a href=\"#nginx-%EC%84%A4%EC%A0%95\">Nginx 설정</a></li>\n<li><a href=\"#%EA%B8%B0%ED%83%80-%EC%84%A4%EC%A0%95-%EC%B0%B8%EA%B3%A0%EC%9A%A9\">기타 설정 (참고용)</a></li>\n</ul>","frontmatter":{"title":"[셀럽잇] 무중단 배포 적용기","date":"2023년 10월 21일","dateISO":"2023-10-21","description":"[셀럽잇] 무중단 배포 적용기","tags":["셀럽잇","zero-downtime-deployment"]}},"previous":{"fields":{"slug":"/InfraStructure/무중단-배포에-대해서/"},"frontmatter":{"title":"무중단 배포에 대해서"}},"next":{"fields":{"slug":"/운영체제/운영체제-인터뷰-스터디/운영체제-인터뷰-스터디-1주차/"},"frontmatter":{"title":"운영체제 인터뷰 스터디 1주차"}}},"pageContext":{"id":"fb649a13-ad43-5201-8788-27364a0951cc","previousPostId":"258b52e8-9e36-5573-b672-ee6c11708e6c","nextPostId":"de64ed1c-c5dc-5e0d-ac8b-8fc57bd92ddc"}},"staticQueryHashes":["2476208942","2637872971","3414707483"],"slicesMap":{}}